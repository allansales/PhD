---
title: "Descrição Noticias"
author: "Allan Sales"
date: "22 de junho de 2017"
output:
  html_document: default
  pdf_document:
    latex_engine: lualatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("mongo_utils.R")
library(corrr)

library(tm)
library(wordcloud2)
library(readr)

library(stringr)

noticias <- get_todas_noticias()

n_palavras <- noticias %>% select(conteudo) %>% 
  unlist() %>% as.vector() %>% 
  tolower() %>% str_count(" ")+1

noticias <- cbind(noticias, n_palavras)

noticias_estadao <- noticias %>% filter(subFonte == "ESTADAO")
noticias_folha <- noticias %>% filter(subFonte == "FOLHASP")
noticias_g1 <- noticias %>% filter(subFonte == "G1")
```
# Bases de dados

## Sumário  dos dados

Este documento apresenta uma descrição da coleta de notícias nos cadernos de política dos portais G1, Estadão e Folha de São Paulo. De cada notícia foram coletadas informaçãoes sobre data de publicação (timestamp), fonte (subFonte), título, subtítulo, conteúdo, emissor, url e número de comentários na notícia (repercussão). Outras informações contidas na base foram adicionadas manualmente ou são derivadas das originais. Do total de notícias coletados, `r nrow(noticias_estadao)` são provenientes do jornal Estadão, `r nrow(noticias_folha)` são provenientes da Folha de São Paulo e `r nrow(noticias_g1)` são do G1.

```{r, echo=F,warning=F}
summary(noticias)
```

### Exemplo de notícia
Notícia com `r max(noticias$repercussao)` comentários:

![Caption for the picture.](/home/allan/workspace/PhD/src/vies jornais/analise_descritiva_portais/comentarios.png)

## Distribuição do número de comentários por portal
É possível visualizar ainda a partir do sumário que diversas são as notícias que não são comentadas. De fato, pelo menos 50% das notícias de toda a base apresentam até `r median(noticias$repercussao)` comentário(s). Considerando apenas as notícias comentadas, podemos visualizar a distribuição da repercurssão para cada portal de notícias da seguinte forma:
```{r, echo=FALSE}
noticias %>% filter(repercussao > 0) %>%
  ggplot() + geom_density(aes(repercussao, ..count.., group=subFonte, color = subFonte), kernel = "gaussian") + scale_x_log10()
  
```

## Distribuição do número de palavras por portal
Além dos comentários, também é possível visualizar a distribuição do número de palavras de cada notícia. Isso é importante pode ser utilizado para se medir o detalhamento que o portal dá a sua notícias. Por exemplo, inferir se para notícias do assunto X o portal costuma fazer notícias resumidas enquanto para notícias do assunto Y as notícias são mais detalhadas.
```{r, echo=FALSE}
noticias %>% filter(repercussao > 0) %>%
  ggplot() + geom_violin(aes(subFonte, n_palavras), kernel = "gaussian")
```

## Número de notícias por ano
Total de notícias por ano apresentada na base de dados.
```{r, echo=F,warning=F, eval=TRUE, echo=FALSE}
ggplot(noticias) + geom_bar(aes(x=ano))
```

## Número de notícias por portal

### Distribuição de notícias por ano
Total de notícias por ano e separadas por portal na base de dados. É possível notar-se, a partir desse gráfico que as notícias coletadas no site do G1 ainda precisam ser colhidas novamente. O ano de 2010, 2014 e 2017 indicam o problema.
```{r, echo=F,warning=F}
ggplot(noticias) + geom_bar(aes(x=ano, fill=subFonte), position = "dodge")
```

### Densidade de noticias por dia
Assim como o gráfico de barras anterior, o gráfico de densidade reforça a indicação de problemas na base do G1. Além disso, é possível visualizar uma tendência dos portais Estadão e Folha de São Paulo em publicar notícias de forma similar. Em períodos semelhantes as duas linhas crescem ou decrescem de forma similar. O que nos leva a pensar que pode existir uma correlação entre os portais.

```{r, echo=F,warning=F}
ggplot(noticias) + geom_density(mapping = aes(x = data, ..count.., group=subFonte, color = subFonte))
```

### Correlações de quantidades de notícias por portais
Os valores de correlação entre os portais são apresentados na tabela a seguir. Nota-se que, como especulado anteriormente, os portais Folha de São Paulo e Estadão apresentam um valor de correlação considerado alto, mas a surpresa dá-se pela relação entre G1 e Folha. Mesmo com problemas na coleta, a correlação entre esses dois portais que resultou no maior valor obtido.
```{r, echo=F}
# correlacao das noticias por dia
correlacao_n_noticias_portal <- noticias %>% 
  select(data, subFonte) %>% 
  table() %>% 
  correlate(method="spearman")

print(correlacao_n_noticias_portal)
```

## Média de publicação de notícias por mês

### Para todos os anos
Uma forma de visualizar a quantidade de notícias que cada portal publica por mês é utilizando a média juntamente ao desvio padrão. Abaixo aprensenta-se um gráfico com média e um intervalo de um desvio padrão para cima e para baixo, para cada portal. Nota-se que o portal G1 publica uma quantidade média de notícias relativamente parecidas durante todo o ano. Por outro lado, para o Estadao e para a Folha, as notícias tendem a ser publicadas com mais frequências nos meses que antecedem eleições. Todavia, o desvio padrão aumenta consideravelmente nesses meses, o que nos dá a entender que a média de publicação naqueles meses deve cair em anos que não há eleição.
```{r, echo=F,warning=F}
# medias e desvios padroes dos portais por mes
n_noticias_mes_ano <- noticias %>% group_by(ano, mes, subFonte) %>% summarise(numero = n())
ic_noticias_mes <- n_noticias_mes_ano %>% group_by(mes, subFonte) %>% 
  summarise(media = mean(numero), erro = qt(0.975,df=n()-1)*sd(numero)/sqrt(n()))
ggplot(ic_noticias_mes) + geom_pointrange(aes(subFonte, media, ymin=media-erro, ymax=media+erro)) + facet_wrap(~mes) 
```

### Separando anos de eleição e anos sem eleição
Para saber se há diferença de publicação nos anos de eleição e nos anos de eleição, pode-se utilizar o intervalo de confiança de publicações nesses meses. Na figura abaixo, percebe-se que há sim o aumento de na média de publicações nos jornais Estadão e Folha de São Paulo. A medida que outubro vai se aproximando, a quantidade de publicações tende a crescer. No mês de outubro e setembro a distância é visualmente grande. Apesar disso, ainda é necessário aplicar o teste t para validar a informação de que há diferença estatística significante entre elas.
```{r, echo=F,warning=F}
## separando por ano de eleicao
# intervalo de confianca de quantidade de noticias por mes
n_noticias_mes_ano_eleicao <- noticias %>% group_by(ano, mes, is_ano_eleicao, subFonte) %>% summarise(numero = n())

ic_noticias_mes_eleicao <- n_noticias_mes_ano_eleicao %>% group_by(mes, is_ano_eleicao, subFonte) %>% 
  summarise(media = mean(numero), erro = qt(0.975,df=n()-1)*sd(numero)/sqrt(n()))

ggplot(ic_noticias_mes_eleicao) + geom_pointrange(mapping = aes(subFonte, media, ymin=media-erro, ymax=media+erro, color=is_ano_eleicao), position = position_dodge(width = 0.5)) + facet_wrap(~mes)
```

# Viés

O objetivo principal da pesquisa é encontrar e quantificar viés nas notícias. Viés pode ser definido como tudo que não for equilibrado. A inclinação política de um portal a um candidato, partido ou idéia são exemplos de viéses relacionados à política. 

```{r, echo=F, include=F, warning=F}
conteudo_estadao <- select(noticias_estadao, conteudo)
conteudo_folha <- select(noticias_folha, conteudo)

titulo_estadao <- select(noticias_estadao, titulo)
titulo_folha <- select(noticias_folha, titulo)

gera_tabela_frequencias <- function(texto){

  texto <- Corpus(VectorSource(texto))
  texto <- tm_map(texto, tolower)
  texto <- tm_map(texto, removePunctuation, preserve_intra_word_dashes = TRUE)
  texto <- tm_map(texto, removeWords, stopwords("pt"))
  texto <- tm_map(texto, removeNumbers)
  texto <- tm_map(texto, stripWhitespace)
  texto <- tm_map(texto, stemDocument)
  texto <- tm_map(texto, PlainTextDocument)


  dtm <- TermDocumentMatrix(texto)
  matriz <- as.matrix(dtm)
  vector <- sort(rowSums(matriz),decreasing=TRUE)
  data <- data.frame(word = names(vector),freq=vector)

  return(data)
}

#tf_conteudo_estadao <- gera_tabela_frequencias(conteudo_estadao)
#tf_conteudo_folha <- gera_tabela_frequencias(conteudo_folha)
#write_csv(tf_conteudo_estadao, "frequencia_palavras_estadao.csv")
#write_csv(tf_conteudo_folha, "frequencia_palavras_folha.csv")
```

## Escolha das palavras

Uma forma simples de verificar a presença de viés é verificando as palavras mais frequêntes de cada texto. Nesse exemplo, faremos isso para a Folha de São Paulo e para o Estadão, tanto para os títulos das matérias quanto para o seu conteúdo.

### Jornal Estadão

#### Título 
Wordcloud de termos mais utilizados nos títulos do jornal Estadão. Algumas palavras para se destacar: diz, impeachment, nega, cpi, mil.
```{r, echo=F,warning=F}
tf_titulo_estadao <- gera_tabela_frequencias(titulo_estadao)
wordcloud2(head(tf_titulo_estadao,100),  fontFamily = 'Segoe UI', size = 1, color = "random-light")
```

#### Conteúdo
Wordcloud de termos mais utilizados nos conteúdos do jornal Estadão.
```{r, echo=F,warning=F}
tf_estadao <- read_csv("frequencia_palavras_estadao.csv")
wordcloud2(head(tf_estadao,100),  fontFamily = 'Segoe UI', size = 1, color = "random-light")
```

### Jornal Folha de São Paulo

#### Título
Wordcloud de termos mais utilizados nos títulos do jornal Folha de São Paulo. Algumas palavras para se destacar: diz, cpi, nega, mil.
```{r, echo=F,warning=F}
tf_titulo_folha <- gera_tabela_frequencias(titulo_folha)
wordcloud2(head(tf_titulo_folha,100),  fontFamily = 'Segoe UI', size = 1, color = "random-light")
```

#### Conteúdo
Wordcloud de termos mais utilizados nos conteúdos do jornal Folha de São Paulo.
```{r, echo=F,warning=F}
tf_folha <- read_csv("frequencia_palavras_folha.csv")
wordcloud2(head(tf_folha,100),  fontFamily = 'Segoe UI', size = 1, color = "random-light")
```

## Escolha de que notícias publicar

Outra forma de viés é intrísseca do próprio jornalista. É a tomada de decisão sobre se a notícia vale a pena de ser publicada ou não. Como exemplo desse tipo de viés, mostramos alguns números a respeito de operações realizadas pela polícia federal e quanto de atenção cada operação teve dos veículos.

As operações utilizadas são:

* Operação Boca Livre: Fraude na Lei Rouanet - lei que institui políticas públicas para a cultura nacional;

* Operação Bullish: irregularidades em empréstimos do BNDES ao Frigorífico JBS;

* Operação Carne Fraca: grandes frigoríficos comercializavam e exportavam carnes vencidas mantidas com ácido sórbico e ácido ascórbico e pagamentos de propinas à fiscais do Ministério da Agricultura;

* Operação Perfídia: lavagem internacional de dinheiro por agências de turismo, casas lotéricas e postos de gasolina;

* Operação Zelotes: investigar um esquema de corrupção no Conselho de Administração de Recursos Fiscais (Carf), órgão colegiado do Ministério da Fazenda, responsável por julgar os recursos administrativos de autuações contra empresas e pessoas físicas por sonegação fiscal e previdenciária.

### Quantidade de notícias - título
Buscando pelo nome da operação nos títulos das matérias em cada jornal obtemos:
```{r, echo=F, warning=F}
#conta numero de noticias com cada candidato / escandalo
noticias_tema <- function(data, pattern, secao, subfonte){
  true_false_vector <- data %>% select(secao) %>% 
    unlist() %>% as.vector() %>% 
    tolower() %>% str_detect(pattern)

  media_palavras <- data %>% filter(true_false_vector == TRUE) %>% select(n_palavras) %>% colMeans()
  
  if(is.nan(media_palavras)){
    n_noticias <- 0
    media_palavras <- 0
  } else {
    n_noticias <- table(true_false_vector)[[2]]    
  }
  
  return(list(n_noticias = n_noticias, media_palavras = media_palavras,
              secao = secao, subfonte = subfonte, busca = pattern))
}

#match pelo titulo das noticias
op_titulo_estadao_bullish <- noticias_tema(noticias_estadao, "bullish", "titulo", "estadao")
op_titulo_estadao_perfidia <- noticias_tema(noticias_estadao, "perfídia", "titulo", "estadao")
op_titulo_estadao_carne_fraca <- noticias_tema(noticias_estadao, "carne fraca", "titulo", "estadao")
op_titulo_estadao_zelotes <- noticias_tema(noticias_estadao, "zelotes", "titulo", "estadao")
op_titulo_estadao_boca_livre <- noticias_tema(noticias_estadao, "boca livre", "titulo", "estadao")

op_titulo_folha_bullish <- noticias_tema(noticias_folha, "bullish", "titulo", "folha")
op_titulo_folha_perfidia <- noticias_tema(noticias_folha, "perfídia", "titulo", "folha")
op_titulo_folha_carne_fraca <- noticias_tema(noticias_folha, "carne fraca", "titulo", "folha")
op_titulo_folha_zelotes <- noticias_tema(noticias_folha, "zelotes", "titulo", "folha")
op_titulo_folha_boca_livre <- noticias_tema(noticias_folha, "boca livre", "titulo", "folha")

match_titulos <- list(op_titulo_estadao_bullish, op_titulo_estadao_perfidia, op_titulo_estadao_carne_fraca,
                      op_titulo_estadao_zelotes, op_titulo_estadao_boca_livre, op_titulo_folha_bullish, op_titulo_folha_perfidia, op_titulo_folha_carne_fraca,
                      op_titulo_folha_zelotes, op_titulo_folha_boca_livre)

match_titulos <- data.table::rbindlist(match_titulos)

ggplot(match_titulos) + geom_col(aes(x=busca, y=n_noticias, fill=subfonte), position = "dodge")
```

### Quantidade de notícias - conteúdo
Sabendo que não necessariamente uma matéria precisa apresentar o nome da operação no seu título, extendemos a busca também para o conteúdo das notícias. A figura apresenta o número de vezes que a operação é mencionada em suas matérias. Casos em que o nome da operação aparece mais de uma vez na mesma matéria não foram tratados.
```{r, echo=F, warning=F}
# match pelo conteudo das noticias
op_conteudo_estadao_bullish <- noticias_tema(noticias_estadao, "bullish", "conteudo", "estadao")
op_conteudo_estadao_perfidia <- noticias_tema(noticias_estadao, "perfídia", "conteudo", "estadao")
op_conteudo_estadao_carne_fraca <- noticias_tema(noticias_estadao, "carne fraca", "conteudo", "estadao")
op_conteudo_estadao_zelotes <- noticias_tema(noticias_estadao, "zelotes", "conteudo", "estadao")
op_conteudo_estadao_boca_livre <- noticias_tema(noticias_estadao, "boca livre", "conteudo", "estadao")

op_conteudo_folha_bullish <- noticias_tema(noticias_folha, "bullish", "conteudo", "folha")
op_conteudo_folha_perfidia <- noticias_tema(noticias_folha, "perfídia", "conteudo", "folha")
op_conteudo_folha_carne_fraca <- noticias_tema(noticias_folha, "carne fraca", "conteudo", "folha")
op_conteudo_folha_zelotes <- noticias_tema(noticias_folha, "zelotes", "conteudo", "folha")
op_conteudo_folha_boca_livre <- noticias_tema(noticias_folha, "boca livre", "conteudo", "folha")

match_conteudo <- list(op_conteudo_estadao_bullish, op_conteudo_estadao_perfidia,
                       op_conteudo_estadao_carne_fraca, op_conteudo_estadao_zelotes, op_conteudo_estadao_boca_livre, op_conteudo_folha_bullish, op_conteudo_folha_perfidia,
                       op_conteudo_folha_carne_fraca, op_conteudo_folha_zelotes, op_conteudo_folha_boca_livre)

match_conteudo <- data.table::rbindlist(match_conteudo)

dados_noticias <- bind_rows(match_conteudo, match_titulos)

ggplot(match_conteudo) + geom_col(aes(x=busca, y=n_noticias, fill=subfonte), position = "dodge")
```

### Quantidade de notícias x lava jato - título
Para fins de comparação com a lava jato.
```{r, echo=F, warning=F}
op_titulo_estadao_lava_jato <- noticias_tema(noticias_estadao, "lava jato", "titulo", "estadao")
op_titulo_folha_lava_jato <- noticias_tema(noticias_folha, "lava jato", "titulo", "folha")

match_titulos_lj <- list(op_titulo_estadao_lava_jato, op_titulo_folha_lava_jato, op_titulo_estadao_bullish, op_titulo_estadao_perfidia, op_titulo_estadao_carne_fraca,
                      op_titulo_estadao_zelotes, op_titulo_estadao_boca_livre, op_titulo_folha_bullish, op_titulo_folha_perfidia, op_titulo_folha_carne_fraca,
                      op_titulo_folha_zelotes, op_titulo_folha_boca_livre)

match_titulos_lj <- data.table::rbindlist(match_titulos_lj)
ggplot(match_titulos_lj) + geom_col(aes(x=busca, y=n_noticias, fill=subfonte), position = "dodge")
```

### Quantidade de notícias x lava jato - conteúdo
Para fins de comparação com a lava jato.
```{r, echo=F, warning=F}
op_conteudo_estadao_lava_jato <- noticias_tema(noticias_estadao, "lava jato", "conteudo", "estadao")
op_conteudo_folha_lava_jato <- noticias_tema(noticias_folha, "lava jato", "conteudo", "folha")

match_conteudo_lj <- list(op_conteudo_estadao_lava_jato, op_conteudo_folha_lava_jato, op_conteudo_estadao_bullish, op_conteudo_estadao_perfidia,
                       op_conteudo_estadao_carne_fraca, op_conteudo_estadao_zelotes, op_conteudo_estadao_boca_livre, op_conteudo_folha_bullish, op_conteudo_folha_perfidia,
                       op_conteudo_folha_carne_fraca, op_conteudo_folha_zelotes, op_conteudo_folha_boca_livre)
match_conteudo_lj <- data.table::rbindlist(match_conteudo_lj)

ggplot(match_conteudo_lj) + geom_col(aes(x=busca, y=n_noticias, fill=subfonte), position = "dodge")

```

## Inclinação partidária ou a um político
Teoricamente toda notícia publicada é imparcial mas é quase impossível realmente mostrar imparcialidade em todas as notícias. Para iniciar a verificação da inclinação política partidária ou pessoal de cada jornal, utilizamos a eleição de 2014 como parâmetro. O período das notícias vai de 6 de julho de 2014 a 6 de outubro de 2014, dia da votação do primeiro turno.

### Número de notícias sobre cada candidato
De forma similar ao que já foi apresentado, pode-se verificar quantas notícias foram publicadas sobre cada um dos candidatos. Percebe-se que Dilma era mais citada na Folha de São Paulo do que qualquer outro político, mas sendo acompanhada de perto por Marina e com uma larga vantagem para Aécio e os outros candidatos. Até mesmo Lula, que não era candidato nessa eleição, tinha mais matérias sendo citado do que alguns dos candidatos.

```{r, echo=F, warning=F}
noticias_estadao_eleicao <- noticias_estadao %>% filter(ano==2014, dia_do_ano >=187, dia_do_ano<=279)
noticias_folha_eleicao <- noticias_folha %>% filter(ano==2014, dia_do_ano >=187, dia_do_ano<=279)


dilma_estadao <- noticias_tema(noticias_estadao_eleicao, "dilma", "titulo", "estadao")
lula_estadao <- noticias_tema(noticias_estadao_eleicao, "lula", "titulo", "estadao")
marina_estadao <- noticias_tema(noticias_estadao_eleicao, "marina", "titulo", "estadao")
levy_estadao <- noticias_tema(noticias_estadao_eleicao, "levy", "titulo", "estadao")
aecio_estadao <- noticias_tema(noticias_estadao_eleicao, "aécio", "titulo", "estadao")
eduardo_jorge_estadao <- noticias_tema(noticias_estadao_eleicao, "eduardo jorge", "titulo", "estadao")
luciana_estadao <- noticias_tema(noticias_estadao_eleicao, "luciana genro", "titulo", "estadao")

dilma_folha <- noticias_tema(noticias_folha_eleicao, "dilma", "titulo", "folha")
lula_folha <- noticias_tema(noticias_folha_eleicao, "lula", "titulo", "folha")
marina_folha <- noticias_tema(noticias_folha_eleicao, "marina", "titulo", "folha")
levy_folha <- noticias_tema(noticias_folha_eleicao, "levy", "titulo", "folha")
aecio_folha <- noticias_tema(noticias_folha_eleicao, "aécio", "titulo", "folha")
eduardo_jorge_folha <- noticias_tema(noticias_folha_eleicao, "eduardo jorge", "titulo", "folha")
luciana_folha <- noticias_tema(noticias_folha_eleicao, "luciana genro", "titulo", "folha")

match_politicos_titulo <- list(dilma_folha, dilma_estadao, lula_estadao, lula_folha, marina_estadao, marina_folha, levy_estadao, levy_folha, 
                               aecio_estadao, aecio_folha, eduardo_jorge_estadao, eduardo_jorge_folha, luciana_estadao, luciana_folha)

match_politicos_titulo <- data.table::rbindlist(match_politicos_titulo)

ggplot(match_politicos_titulo) + geom_col(aes(x=busca, y=n_noticias, fill=subfonte), position = "dodge")
```

### Média de palavras por notícia
Pode-se questionar que mesmo que a quantidade de notícias seja a mesma, a discussão sobre aquele candidato não seja detalhada. Sendo assim, pode-se medir a quantidade média de palavras que eram escritas nos artigos falando de cada candidato. Nesse caso, nota-se que não há uma grande diferença de uns para os outros.
```{r, echo=F}
ggplot(match_politicos_titulo) + geom_col(aes(x=busca, y=media_palavras, fill=subfonte), position = "dodge")
```

